<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>테이블 병합 테스트</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .table-info {
            background: #f5f5f5;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        
        table {
            border-collapse: collapse;
            margin: 20px 0;
            width: 100%;
        }
        
        th, td {
            border: 1px solid #333;
            padding: 8px;
            text-align: center;
            min-width: 60px;
        }
        
        th {
            background: #e0e0e0;
            font-weight: bold;
        }
        
        .merged {
            background: #ffffcc;
        }
        
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        
        .success {
            background: #d4edda;
            color: #155724;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
        }
        
        pre {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            overflow: auto;
            max-height: 300px;
        }
        
        .table-container {
            display: flex;
            gap: 20px;
            margin: 20px 0;
        }
        
        .table-panel {
            flex: 1;
        }
        
        h3 {
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 5px;
        }
    </style>
</head>
<body>
    <h1>HWPX 테이블 병합 테스트</h1>
    
    <div id="status"></div>
    
    <div id="tables"></div>
    
    <script type="module">
        async function testTableMerge() {
            const statusDiv = document.getElementById('status');
            const tablesDiv = document.getElementById('tables');
            
            try {
                statusDiv.innerHTML = '<div class="status">테이블 분석 중...</div>';
                
                // HWPX JSON 파일 로드
                const response = await fetch('/temp/인천정각중학교 교육실습 운영 계획 (1) (1).json');
                const hwpxJson = await response.json();
                
                // 병합이 있는 테이블 찾기
                function findTablesWithMerge(node, path = '', results = []) {
                    if (node.tag === 'tbl') {
                        const rows = node.children?.filter(c => c.tag === 'tr') || [];
                        let hasMerge = false;
                        const mergeMap = [];
                        
                        rows.forEach((row, rowIdx) => {
                            const rowMerges = [];
                            const cells = row.children?.filter(c => c.tag === 'tc') || [];
                            
                            cells.forEach((cell, cellIdx) => {
                                const cellSpan = cell.children?.find(c => c.tag === 'cellSpan');
                                let colspan = 1, rowspan = 1;
                                
                                if (cellSpan?.attributes) {
                                    colspan = parseInt(cellSpan.attributes.colSpan || '1');
                                    rowspan = parseInt(cellSpan.attributes.rowSpan || '1');
                                    if (colspan > 1 || rowspan > 1) hasMerge = true;
                                }
                                
                                rowMerges.push({ colspan, rowspan });
                            });
                            
                            mergeMap.push(rowMerges);
                        });
                        
                        if (hasMerge) {
                            results.push({
                                path,
                                table: node,
                                mergeMap,
                                rowCnt: parseInt(node.attributes?.rowCnt || '0'),
                                colCnt: parseInt(node.attributes?.colCnt || '0')
                            });
                        }
                    }
                    
                    if (node.children) {
                        node.children.forEach((child, i) => {
                            findTablesWithMerge(child, path + '/' + child.tag + '[' + i + ']', results);
                        });
                    }
                    
                    return results;
                }
                
                const section = hwpxJson.content.sections[0].data.parsed_structure;
                const tablesWithMerge = findTablesWithMerge(section);
                
                statusDiv.innerHTML = `<div class="status success">✅ ${tablesWithMerge.length}개의 병합된 테이블을 찾았습니다.</div>`;
                
                // 각 테이블 표시
                let html = '';
                tablesWithMerge.forEach((tableInfo, idx) => {
                    html += `<div class="table-info">`;
                    html += `<h3>테이블 ${idx + 1}</h3>`;
                    html += `<p>크기: ${tableInfo.rowCnt} × ${tableInfo.colCnt}</p>`;
                    html += `<p>경로: ${tableInfo.path}</p>`;
                    
                    // 테이블 시각화
                    html += '<table>';
                    
                    tableInfo.mergeMap.forEach((row, rowIdx) => {
                        html += '<tr>';
                        row.forEach((cell, cellIdx) => {
                            const classNames = [];
                            if (cell.colspan > 1 || cell.rowspan > 1) {
                                classNames.push('merged');
                            }
                            
                            html += `<td class="${classNames.join(' ')}" colspan="${cell.colspan}" rowspan="${cell.rowspan}">`;
                            html += `R${rowIdx}C${cellIdx}`;
                            if (cell.colspan > 1 || cell.rowspan > 1) {
                                html += `<br><small>(${cell.colspan}×${cell.rowspan})</small>`;
                            }
                            html += '</td>';
                        });
                        html += '</tr>';
                    });
                    
                    html += '</table>';
                    
                    // 병합 정보
                    html += '<details>';
                    html += '<summary>병합 정보 상세</summary>';
                    html += '<pre>' + JSON.stringify(tableInfo.mergeMap, null, 2) + '</pre>';
                    html += '</details>';
                    
                    html += '</div>';
                });
                
                tablesDiv.innerHTML = html;
                
                // Converter 테스트
                const { HWPXToCanvasConverter } = await import('/src/converters/hwpx-to-canvas/HWPXToCanvasConverter.ts');
                const converter = new HWPXToCanvasConverter({
                    preserveStyles: true,
                    preserveLayout: true,
                    tableDefaultBorder: true
                });
                
                const result = converter.convertSync(hwpxJson);
                
                if (result.success && result.data) {
                    const tables = result.data.data.main.filter(el => el.type === 13);
                    console.log('Converted tables:', tables);
                    
                    // 변환된 테이블 정보 추가
                    let convertedHtml = '<h2>변환된 테이블 구조</h2>';
                    tables.forEach((table, idx) => {
                        convertedHtml += `<div class="table-info">`;
                        convertedHtml += `<h3>변환된 테이블 ${idx + 1}</h3>`;
                        convertedHtml += `<p>행 수: ${table.trList?.length || 0}</p>`;
                        convertedHtml += `<p>컬럼 수: ${table.colgroup?.length || 0}</p>`;
                        
                        // 병합 정보 표시
                        const merges = [];
                        table.trList?.forEach((tr, rowIdx) => {
                            tr.tdList?.forEach((td, colIdx) => {
                                if (td.colspan > 1 || td.rowspan > 1) {
                                    merges.push({
                                        row: rowIdx,
                                        col: colIdx,
                                        colspan: td.colspan,
                                        rowspan: td.rowspan
                                    });
                                }
                            });
                        });
                        
                        if (merges.length > 0) {
                            convertedHtml += '<p>병합된 셀:</p>';
                            convertedHtml += '<pre>' + JSON.stringify(merges, null, 2) + '</pre>';
                        }
                        
                        convertedHtml += '</div>';
                    });
                    
                    tablesDiv.innerHTML += convertedHtml;
                }
                
            } catch (error) {
                console.error('Error:', error);
                statusDiv.innerHTML = '<div class="status error">❌ 오류: ' + error.message + '</div>';
            }
        }
        
        // 페이지 로드 시 실행
        testTableMerge();
    </script>
</body>
</html>